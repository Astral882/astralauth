<script>
let failCount = 0;
let idFrontImage = '';
let idBackImage = '';
let faceImage = '';

function startCamera() {
  const video = document.getElementById('video');
  const startBtn = document.getElementById('startBtn');
  const captureBtn = document.getElementById('captureBtn');

  navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
    video.srcObject = stream;
    video.style.display = 'block';
    captureBtn.style.display = 'inline-block';
    startBtn.style.display = 'none';
  }).catch(err => {
    alert("Camera access denied.");
  });
}

function captureFace() {
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const context = canvas.getContext('2d');
  canvas.width = 300;
  canvas.height = 300;
  context.drawImage(video, 0, 0, canvas.width, canvas.height);

  faceImage = canvas.toDataURL('image/jpeg').split(',')[1];

  fetch('https://api-us.faceplusplus.com/facepp/v3/detect', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: `api_key=V2E7Fw194WeXnY34Vf5caVjPVPSfDPU&api_secret=4air9mNevxtAVmcsgqfmURHNeNrhaQtl&image_base64=${faceImage}`
  })
  .then(response => response.json())
  .then(data => {
    if (data.faces && data.faces.length === 1) {
      document.getElementById('registerForm').style.display = 'flex';
      document.getElementById('status').innerText = "Face verification success! Please continue.";
    } else {
      failCount++;
      if (failCount >= 3) {
        document.getElementById('status').innerText = "Face verification failed 3 times. Registration locked.";
        document.getElementById('captureBtn').disabled = true;
      } else {
        document.getElementById('status').innerText = `Face verification failed. Try again (${failCount}/3)`;
      }
    }
  })
  .catch(err => {
    document.getElementById('status').innerText = "Error verifying face.";
  });
}

function captureID(side) {
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const context = canvas.getContext('2d');
  canvas.width = 300;
  canvas.height = 300;
  context.drawImage(video, 0, 0, canvas.width, canvas.height);

  const image = canvas.toDataURL('image/jpeg').split(',')[1];
  if (side === 'front') {
    idFrontImage = image;
    alert("Captured ID Front successfully!");
  } else if (side === 'back') {
    idBackImage = image;
    alert("Captured ID Back successfully!");
  }
}

document.getElementById('registerForm').addEventListener('submit', function(e) {
  e.preventDefault();

  const fullname = document.getElementById('fullname').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const email = document.getElementById('email').value.trim();
  const country = document.getElementById('country').value.trim();

  if (!idFrontImage || !idBackImage || !faceImage) {
    alert("Please capture all required photos!");
    return;
  }

  alert("Registration submitted!\n(Next Step: send data to server or email manually.)");

  // TODO: 这里可以加实际发Email流程 或 发送服务器存储
});
</script>
</body>
</html>
<script>
let failCount = 0;
let idFrontImage = '';
let idBackImage = '';
let faceImage = '';

function startCamera() {
  const video = document.getElementById('video');
  const startBtn = document.getElementById('startBtn');
  const captureBtn = document.getElementById('captureBtn');

  navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
    video.srcObject = stream;
    video.style.display = 'block';
    captureBtn.style.display = 'inline-block';
    startBtn.style.display = 'none';
  }).catch(err => {
    alert("Camera access denied.");
  });
}

function captureFace() {
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const context = canvas.getContext('2d');
  canvas.width = 300;
  canvas.height = 300;
  context.drawImage(video, 0, 0, canvas.width, canvas.height);

  faceImage = canvas.toDataURL('image/jpeg').split(',')[1];

  fetch('https://api-us.faceplusplus.com/facepp/v3/detect', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: `api_key=V2E7Fw194WeXnY34Vf5caVjPVPSfDPU&api_secret=4air9mNevxtAVmcsgqfmURHNeNrhaQtl&image_base64=${faceImage}`
  })
  .then(response => response.json())
  .then(data => {
    if (data.faces && data.faces.length === 1) {
      document.getElementById('registerForm').style.display = 'flex';
      document.getElementById('status').innerText = "Face verification success! Please continue.";
    } else {
      failCount++;
      if (failCount >= 3) {
        document.getElementById('status').innerText = "Face verification failed 3 times. Registration locked.";
        document.getElementById('captureBtn').disabled = true;
      } else {
        document.getElementById('status').innerText = `Face verification failed. Try again (${failCount}/3)`;
      }
    }
  })
  .catch(err => {
    document.getElementById('status').innerText = "Error verifying face.";
  });
}

function captureID(side) {
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const context = canvas.getContext('2d');
  canvas.width = 300;
  canvas.height = 300;
  context.drawImage(video, 0, 0, canvas.width, canvas.height);

  const image = canvas.toDataURL('image/jpeg').split(',')[1];
  if (side === 'front') {
    idFrontImage = image;
    alert("Captured ID Front successfully!");
  } else if (side === 'back') {
    idBackImage = image;
    alert("Captured ID Back successfully!");
  }
}

document.getElementById('registerForm').addEventListener('submit', function(e) {
  e.preventDefault();

  const fullname = document.getElementById('fullname').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const email = document.getElementById('email').value.trim();
  const country = document.getElementById('country').value.trim();

  if (!idFrontImage || !idBackImage || !faceImage) {
    alert("Please capture all required photos!");
    return;
  }

  alert("Registration submitted!\n(Next Step: send data to server or email manually.)");

  // TODO: 这里可以加发送Email功能，或存到服务器
});
</script>
</body>
</html>
